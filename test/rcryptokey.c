#include <rlib/rlib.h>

RTEST (rcryptokey, import_ssh_public_key, RTEST_FAST)
{
  RCryptoKey * key;
  rmpint res, ex;
  static const rchar ssh_pk[] = "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAAAgQDJlkED"
    "b6yg76tKpi4TuTxPnsMI5Wz8q/cNBovF4qiV41Ztu+iQ+OsfZSR8SOpOhzxFy1+gPG+dcMcI"
    "wt9PBH/4PoZkWqXg5+2bnc70/CrMy6JXr2t8QPvZhzLjyB1vcsFWjJ1+HzdyW99S7oBIKN01"
    "mdUY8Qy9kfRfTFJGqmBJWw== test@rlib";
  static const ruint8 pk_m[] = {
    0xc9, 0x96, 0x41, 0x03, 0x6f, 0xac, 0xa0, 0xef, 0xab, 0x4a, 0xa6, 0x2e, 0x13, 0xb9, 0x3c, 0x4f,
    0x9e, 0xc3, 0x08, 0xe5, 0x6c, 0xfc, 0xab, 0xf7, 0x0d, 0x06, 0x8b, 0xc5, 0xe2, 0xa8, 0x95, 0xe3,
    0x56, 0x6d, 0xbb, 0xe8, 0x90, 0xf8, 0xeb, 0x1f, 0x65, 0x24, 0x7c, 0x48, 0xea, 0x4e, 0x87, 0x3c,
    0x45, 0xcb, 0x5f, 0xa0, 0x3c, 0x6f, 0x9d, 0x70, 0xc7, 0x08, 0xc2, 0xdf, 0x4f, 0x04, 0x7f, 0xf8,
    0x3e, 0x86, 0x64, 0x5a, 0xa5, 0xe0, 0xe7, 0xed, 0x9b, 0x9d, 0xce, 0xf4, 0xfc, 0x2a, 0xcc, 0xcb,
    0xa2, 0x57, 0xaf, 0x6b, 0x7c, 0x40, 0xfb, 0xd9, 0x87, 0x32, 0xe3, 0xc8, 0x1d, 0x6f, 0x72, 0xc1,
    0x56, 0x8c, 0x9d, 0x7e, 0x1f, 0x37, 0x72, 0x5b, 0xdf, 0x52, 0xee, 0x80, 0x48, 0x28, 0xdd, 0x35,
    0x99, 0xd5, 0x18, 0xf1, 0x0c, 0xbd, 0x91, 0xf4, 0x5f, 0x4c, 0x52, 0x46, 0xaa, 0x60, 0x49, 0x5b };

  r_assert_cmpptr ((key = r_crypto_key_import_ssh_public_key (ssh_pk, sizeof (ssh_pk))), !=, NULL);
  r_assert_cmpuint (r_crypto_key_get_type (key), ==, R_CRYPTO_PUBLIC_KEY);
  r_assert_cmpuint (r_crypto_key_get_algo (key), ==, R_CRYPTO_ALGO_RSA);
  r_assert_cmpuint (r_crypto_key_get_bitsize (key), ==, sizeof (pk_m) * 8);

  r_mpint_init (&res);
  r_mpint_init_binary (&ex, pk_m, sizeof (pk_m));
  r_assert (r_rsa_pub_key_get_n (key, &res));
  r_assert_cmpmem (res.data, ==, ex.data, sizeof (rmpint_digit) * r_mpint_digits_used (&res));
  r_assert_cmpint (r_mpint_cmp (&res, &ex), ==, 0);

  r_mpint_set_u32 (&ex, 0x010001);
  r_assert (r_rsa_pub_key_get_e(key, &res));
  r_assert_cmpint (r_mpint_cmp (&res, &ex), ==, 0);

  r_mpint_clear (&res);
  r_mpint_clear (&ex);

  r_crypto_key_unref (key);
}
RTEST_END;

RTEST (rcryptokey, import_ssh_public_key_invalid, RTEST_FAST)
{
  static const rchar ssh_pk[] = "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAAAgQDJlkED";
  r_assert_cmpptr (r_crypto_key_import_ssh_public_key (NULL, 1),      ==, NULL);
  r_assert_cmpptr (r_crypto_key_import_ssh_public_key ("ssh-rsa", 1), ==, NULL);
  r_assert_cmpptr (r_crypto_key_import_ssh_public_key ("ssh-rsa", 0), ==, NULL);
  r_assert_cmpptr (r_crypto_key_import_ssh_public_key (ssh_pk, sizeof (ssh_pk)), ==, NULL);
}
RTEST_END;

